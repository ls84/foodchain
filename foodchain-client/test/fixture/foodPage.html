<html>
  <head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
    <script src="../../dist/external/cbor.js" type="text/javascript"></script>
    <script src="../../dist/external/elliptic.min.js" type="text/javascript"></script>
    <script src="../../dist/external/protobuf.min.js" type="text/javascript"></script>
    <script src="../../dist/external/jss.min.js"></script>
    <script src="../../dist/external/jss-nested.min.js"></script>


    <style>
      body {
        background-color: whitesmoke;
      }

      .searchInput {
        width: 100%;
        height: 42px;
        padding-left: 10px;
        font-size: 24px;
        font-family: sans-serif;
        margin-bottom: 10px;
        border: none;
        outline:none;
      }
      
      .searchInput::placeholder {
        padding-left: 10px;
        font-size: 16px;
        font-weight: 100;
        color: lightgrey;
      }

      .signButton {
        height: 30px;
        width: 60px;
        position: relative;
        left: calc(100% - 60px);
        line-height:30px;
        text-align: center;
        background-color: white;
        margin-top: 10px;
        margin-bottom: 20px;
        font-family: sans-serif;
        color: lightgrey;
      }

      .signButton.active {
        color: black
      }

      .submitButton {
        height: 30px;
        width: 60px;
        position: relative;
        left: calc(100% - 60px);
        line-height:30px;
        text-align: center;
        background-color: white;
        margin-top: 10px;
        margin-bottom: 20px;
        font-family: sans-serif;
        color: black;
      }

    </style>
  </head>
  <body>
    <script type="module">
      window.serverAddress = ''

      import { sha256Hex } from '../../src/hashing.js'
      window.sha256Hex = sha256Hex

      import nutrientTable from '../../src/nutrientTable.js'
      customElements.define('nutrient-table', nutrientTable)

      import foodEditor from '../../src/foodEditor.js'
      customElements.define('food-editor', foodEditor)

      import foodItem from '../../src/foodItem.js'
      customElements.define('food-item', foodItem)

      import { generateNewKey, importKey, Sawtooth } from '../../src/sawtooth.js'

      let key
      try {
        key = importKey()
      } catch (error) {
        if (error.message === 'there is no key') key = generateNewKey()
      }

      window.sawtooth = new Sawtooth(key)

      window.worker = new Worker('../../src/indexedDBWorker.js')
      window.NETWorker = new Worker('../../src/NETWorker.js')
      window.NameResolver = new Worker('../../src/NameResolver.js')

    </script>

    <script type='module'>

      window.committedFood = []
      window.signedFoodData = []
      window.submittedFoodData = []

      function populateFoodPage (data) {
        data.forEach((d) => {
          let foodItem = document.createElement('food-item')
          foodItem.init(d, 'DATABASE')

          switch (d.status) {
            case 'SIGNED':
              foodItem.setAttribute('data-status', 'SIGNED')
              document.body.insertBefore(foodItem, submitButton)
              signedFoodData.push(d)

              break
            case 'SUBMITTED':
              foodItem.setAttribute('data-status', 'SUBMITTED')
              foodItem.confirmSubmission = confirmSubmission.bind(foodItem)
              document.body.appendChild(foodItem)
              submittedFoodData.push(d)
              
              break

            case 'COMMITTED':
              foodItem.setAttribute('data-status', 'COMMITTED')
              document.body.appendChild(foodItem)
              committedFood.push(foodItem)

              break
          }
        })

        if (data.filter(d => d.status === 'SIGNED').length > 0) submitButton.hidden = false
      }

      function clearEditor () {
        foodEditor.nutrientTable.shadow.querySelectorAll('li:not(.constituentSelector)').forEach((n) => {
          n.remove()
        })
        foodEditor.nameInput.value = ''
        foodEditor.addressNameState
        foodEditor.nutrientTable.selector.hidden = true
      }

      function appendNewFood (data) {
        let foodItem = document.createElement('food-item')
        foodItem.setAttribute('data-status', 'SIGNED')
        foodItem.init(data, 'DATABASE')
        document.body.insertBefore(foodItem, submitButton)
        submitButton.hidden = false
      }

      function updateFavouriteDOM(data) {
        let add = data[0]
        let remove = data[1]
        add.forEach((d) => {
          let foodItem = document.createElement('food-item')
          foodItem.init(d, 'BLOCK')
          foodItem.setAttribute('data-status', 'COMMITTED')
          document.body.appendChild(foodItem)
        })

        remove.forEach((n) => {
          document.querySelectorAll('food-item[data-status="COMMITTED"]').forEach((e) => {
            if (e.name.textContent === n) e.remove()
          })
        })
      }

      function syncWithAddress () {
        let myAddress = '100000' + sawtooth.key.getPublic().encodeCompressed('hex').substr(2,64)
        NETWorker.postMessage(['FetchMyAddressState', myAddress])
      }

      worker.onmessage = (e) => {
        switch (e.data[0]) {
          case 'AllFoodItems':
            populateFoodPage(e.data[1])
            break

          case 'FavouritesMerged':
            updateFavouriteDOM(e.data[1])
            break
        }
      }

      NETWorker.onmessage = (e) => {
        switch (e.data[0]) {
          case 'MyAddressStateFetched':
            let favourites = e.data[1].favourites
            if (favourites) worker.postMessage(['MergeWithFavourites', favourites])
            break
        }
      }

      document.addEventListener('FoodSigned', (e) => {
        clearEditor()
        appendNewFood(e.detail)
        signedFoodData.push(e.detail)
      }, true)

      document.addEventListener('FoodSubmitted', (e) => {
        if (!e.detail.insert) {
          let nodeList = document.querySelectorAll('food-item[data-status="SIGNED"]')
          let foodItem = Array.from(nodeList)
          .find((n) => n.name.textContent === e.detail.name)
          foodItem.setAttribute('data-status', 'SUBMITTED')
          document.body.appendChild(foodItem)
        }
      }, true)

      document.addEventListener('FoodCommitted', (e) => {
        if (!e.detail.insert) {
          let nodeList = document.querySelectorAll('food-item[data-status="SUBMITTED"]')
          let foodItem = Array.from(nodeList)
          .find((n) => n.name.textContent = e.detail.name)
          foodItem.setAttribute('data-status', 'COMMITTED')
          document.body.appendChild(foodItem)
        }
      }, true)

// Confirm Submission
      
      function confirmUpdateHandler(e) {
        switch(e.data[0]) {
          case 'FoodItemsUpdated':
            e.data[1].forEach((d) => {
              document.dispatchEvent(new CustomEvent('FoodCommitted', { detail: d }))
            })
        }
      }

      function confirmHandler (e) {
        switch (e.data[0]) {
          case 'SubmissionConfirmed':
            let submittedItemsUpdate = submittedFoodData.filter((d) => {
              return d.batchID === e.data[1] 
            })
            .map((d) => {
              d.status = 'COMMITTED'
              return d
            })

            worker.addEventListener('message', confirmUpdateHandler)
            worker.postMessage(['UpdateFoodItems', submittedItemsUpdate])
            break
        }
      }

      const confirmSubmission = function () {
        NETWorker.addEventListener('message', confirmHandler)
        NETWorker.postMessage(['ConfirmSubmission', this.data.batchID])
      }

// Confirm Submission

// Name Change
      function AddressStateHandler (e) {
        console.log(e.data)
        switch (e.data[0]) {
          case 'AddressStateFetched':
            if (e.data[2] === null) {
              foodEditor.addressState.textContent = 'new food'
              signButton.classList.add('active')
            }
            break
        }
      }

      document.addEventListener('NameChanged', (e) => {
        signButton.hidden = (e.detail.isEmpty) ? true : false
        signButton.classList.remove('active')
        foodEditor.addressState.textContent = ''

        let name = e.detail.name

        if (!e.detail.isEmpty) {
          NameResolver.addEventListener('message', AddressStateHandler)
          NameResolver.postMessage([e.detail.name, true])
        }
      }, true)
// Name Change

      let searchInput = document.createElement('input')
      searchInput.classList.value = 'searchInput'
      searchInput.setAttribute('placeholder', 'Search Food Here...')
      searchInput.addEventListener('keyup', (event) => {
        let name = event.target.value
        switch (name) {
          case '' :
            committedFood.forEach((e) => { e.hidden = false })
            break
          default :
          committedFood.filter((e) => !new RegExp(name).test(e.name.textContent))
          .forEach((e) => { e.hidden = true})
        }
      })
      document.body.append(searchInput)

      window.foodEditor = document.createElement('food-editor')
      document.body.appendChild(foodEditor)

      import signButton from '../../src/signButton.js'
      window.signButton = signButton
      document.body.appendChild(signButton)


      
      import submitButton from '../../src/submitButton.js'
      window.submitButton = submitButton
      document.body.appendChild(submitButton)

// initialization steps

      worker.postMessage(['GetAllFoodItems'])
      syncWithAddress()

    </script>
  </body>
</html>

