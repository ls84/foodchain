<html>
  <head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
    <script src="../../dist/external/cbor.js" type="text/javascript"></script>
    <script src="../../dist/external/elliptic.min.js" type="text/javascript"></script>
    <script src="../../dist/external/protobuf.min.js" type="text/javascript"></script>
    <script src="../../dist/external/jss.min.js"></script>
    <script src="../../dist/external/jss-nested.min.js"></script>
    <style>
      body {
        background-color: whitesmoke;
      }

      .signButton {
        height: 30px;
        width: 60px;
        position: relative;
        left: calc(100% - 60px);
        line-height:30px;
        text-align: center;
        background-color: white;
        margin-top: 10px;
        margin-bottom: 20px;
        font-family: sans-serif;
        color: lightgrey;
      }

      .signButton.active {
        color: black
      }

      .submitButton {
        height: 30px;
        width: 60px;
        position: relative;
        left: calc(100% - 60px);
        line-height:30px;
        text-align: center;
        background-color: white;
        margin-top: 10px;
        margin-bottom: 20px;
        font-family: sans-serif;
        color: black;
      }

    </style>
  </head>
  <body>
    <script type="module">
      // window.cbor = CBOR

      import { sha256Hex } from '../../src/hashing.js'
      window.sha256Hex = sha256Hex

      import nutrientTable from '../../src/nutrientTable.js'
      customElements.define('nutrient-table', nutrientTable)

      import foodEditor from '../../src/foodEditor.js'
      customElements.define('food-editor', foodEditor)

      import foodItem from '../../src/foodItem.js'
      customElements.define('food-item', foodItem)

      import { IndexedDB } from '../../src/indexedDB.js'
      window.database = new IndexedDB('foodChain')
      
      import { generateNewKey, importKey, Sawtooth } from '../../src/sawtooth.js'

      let key
      try {
        key = importKey()
      } catch (error) {
        if (error.message === 'there is no key') key = generateNewKey()
      }

      window.sawtooth = new Sawtooth(key)

    </script>

    <script type='module'>
      window.serverAddress = ''

      let request = database.indexedDB.open('foodChain')
      request.onupgradeneeded = function (event) {
        let db = event.target.result
        let version = db.version
        switch (version) {
          case 1:
            let foodStore = db.createObjectStore('food', {keyPath: 'name'})
            foodStore.createIndex('name', 'name', {unique: true})
            foodStore.createIndex('status', 'status', {unique: false})
            foodStore.createIndex('timeStamp', 'timeStamp', {unique: false})

            let consumptionStore = db.createObjectStore('consumption', {keyPath: 'datetime'})
            consumptionStore.createIndex('datetime', 'datetime', {unique: true})
            consumptionStore.createIndex('status', 'status', {unique: false})
            consumptionStore.createIndex('timeStamp', 'timeStamp', {unique: false})
        }
      }

      const timeNow = () => {
        let datetime = new Date()
        let options = {
          year: 'numeric',
          month: 'numeric',
          day: 'numeric',
          hour: 'numeric',
          minute: 'numeric',
          weekday: 'long',
          hour12: false,
          timeZone: 'Asia/Shanghai'
        }
        return {
          'string': new Intl.DateTimeFormat('zh-Hans-CN', options).format(datetime),
          'value': datetime.valueOf()
        }
      }

      const confirmSubmission = function () {
        window.fetch(`${serverAddress}/batch_statuses`, {
          body: JSON.stringify(this.data.batchID),
          headers: {'Content-Type': 'application/json'},
          method: 'POST',
          mode: 'cors'
        })
        .then((response) => {
          if (!response.ok) return Promise.reject(new Error('response is not okay'))
          return response.json()
        })
        .then((json) => {
          if (json.status === 'COMITTED') {
            this.data.status = 'COMITTED'
            return database.updateAll('food', [this.data])
          }
        })
        .then((updated) => {
          this.setAttribute('data-status', 'COMITTED')
          document.body.appendChild(this)
        })
        .catch((error) => {
          console.log(error)
        })
      }

      const SubmitButton = () => {
        let submitButton = document.createElement('div')
        submitButton.classList.add('submitButton')
        submitButton.hidden = true
        submitButton.textContent = 'Submit'

        submitButton.addEventListener('click', (event) => {
          let signedItems = document.querySelectorAll('food-item[data-status = "SIGNED"]')
          let transactions = []
          signedItems.forEach((i) => {
            transactions.push(i.data.transaction)
          })
          
          return sawtooth.buildBatch(transactions)
          .then((batch) => {
            return sawtooth.send([batch], `${serverAddress}/batches`)
          })
          .then((response) => {
            let params = (new URL(response.link)).searchParams
            let batchID = params.get('id')

            let submittedData = []
            signedItems.forEach((i) => {
              i.data.status = 'SUBMITTED'
              i.data.batchID = batchID

              submittedData.push(i.data)
            })

            return database.updateAll('food', submittedData)
          })
          .then((updated) => {
            signedItems.forEach((i) => {
              i.setAttribute('data-status', 'SUBMITTED')
              i.confirmSubmission = confirmSubmission.bind(i)
              document.body.appendChild(i)
            })

            submitButton.hidden = true
          })
          .catch((error) => {
            console.log(error)
          })
        })

        return submitButton
      }

      const SignButton = () => {
        let signButton = document.createElement('div')
        signButton.classList.add('signButton')
        signButton.hidden = true
        signButton.textContent = 'Sign'
        signButton.addEventListener('click', (event) => {
          if (signButton.classList.contains('active')) {
            let data = foodEditor.compileData()

            let foodItem = document.createElement('food-item')
            foodItem.setAttribute('data-status', 'SIGNED')
            foodItem.update(data)
            foodItem.build()
            .then((data) => {
              return database.insertAll('food', [data])
            })
            .then(() => {
              foodEditor.nutrientTable.shadow.querySelectorAll('li:not(.constituentSelector)').forEach((n) => {
                n.remove()
              })
              foodEditor.nameInput.value = ''
              foodEditor.addressNameState
              foodEditor.nutrientTable.selector.hidden = true
              signButton.hidden = true
              document.body.insertBefore(foodItem, submitButton)
              submitButton.hidden = false
            })
          }
        })

        return signButton
      }

      window.foodEditor = document.createElement('food-editor')
      foodEditor.NameAddressStateChange = (state) => {
        if (state === 'NON-EXISTS') signButton.classList.add('active')
      }
      foodEditor.inputStateChange = (state) => {
        if (state === 'NON-EMPTY') signButton.hidden = false
        if (state === 'EMPTY') signButton.hidden = true
        signButton.classList.remove('active')
      }

      document.body.appendChild(foodEditor)

      let signButton = SignButton()
      document.body.appendChild(signButton)

      let submitButton = SubmitButton()
      document.body.appendChild(submitButton)

      database.getAll('food')
      .then(data => {
        data.forEach((d) => {
          let foodItem = document.createElement('food-item')
          foodItem.update(d)

          switch (d.status) {
            case 'SIGNED':
              foodItem.setAttribute('data-status', 'SIGNED')
              document.body.insertBefore(foodItem, submitButton)

              break
            case 'SUBMITTED':
              foodItem.setAttribute('data-status', 'SUBMITTED')
              foodItem.confirmSubmission = confirmSubmission.bind(foodItem)
              document.body.appendChild(foodItem)
              
              break

            case 'COMITTED':
              foodItem.setAttribute('data-status', 'COMITTED')
              document.body.appendChild(foodItem)

              break
          }
        })
        if (data.filter(d => d.status === 'SIGNED')) submitButton.hidden = false
      })

    </script>
  </body>
</html>

