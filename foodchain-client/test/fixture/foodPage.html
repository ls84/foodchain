<html>
  <head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
    <script src="../../dist/external/cbor.js" type="text/javascript"></script>
    <script src="../../dist/external/elliptic.min.js" type="text/javascript"></script>
    <script src="../../dist/external/protobuf.min.js" type="text/javascript"></script>
    <script src="../../dist/external/jss.min.js"></script>
    <script src="../../dist/external/jss-nested.min.js"></script>
    <style>
      body {
        background-color: whitesmoke;
      }

      .signButton {
        height: 30px;
        width: 60px;
        position: relative;
        left: calc(100% - 60px);
        line-height:30px;
        text-align: center;
        background-color: white;
        margin-top: 10px;
        margin-bottom: 20px;
        font-family: sans-serif;
        color: lightgrey;
      }

      .signButton.active {
        color: black
      }

      .submitButton {
        height: 30px;
        width: 60px;
        position: relative;
        left: calc(100% - 60px);
        line-height:30px;
        text-align: center;
        background-color: white;
        margin-top: 10px;
        margin-bottom: 20px;
        font-family: sans-serif;
        color: black;
      }

    </style>
  </head>
  <body>
    <script type="module">
      // window.cbor = CBOR

      import { sha256Hex } from '../../src/hashing.js'
      window.sha256Hex = sha256Hex

      import nutrientTable from '../../src/nutrientTable.js'
      customElements.define('nutrient-table', nutrientTable)

      import foodEditor from '../../src/foodEditor.js'
      customElements.define('food-editor', foodEditor)

      import foodItem from '../../src/foodItem.js'
      customElements.define('food-item', foodItem)

      import { IndexedDB } from '../../src/indexedDB.js'
      window.database = new IndexedDB('foodChain')
      
      import { generateNewKey, importKey, Sawtooth } from '../../src/sawtooth.js'

      let key
      try {
        key = importKey()
      } catch (error) {
        if (error.message === 'there is no key') key = generateNewKey()
      }

      window.sawtooth = new Sawtooth(key)

    </script>

    <script type='module'>
      window.serverAddress = ''

      // database.update()
      // .then((db) => {
      //   let foodStore = db.createObjectStore('food', {keyPath: 'name'})
      //   foodStore.createIndex('name', 'name', {unique: true})
      //   foodStore.createIndex('status', 'status', {unique: false})
      //   foodStore.createIndex('timeStamp', 'timeStamp', {unique: false})

      //   let consumptionStore = db.createObjectStore('consumption', {keyPath: 'datetime'})
      //   consumptionStore.createIndex('datetime', 'datetime', {unique: true})
      //   consumptionStore.createIndex('status', 'status', {unique: false})
      //   consumptionStore.createIndex('timeStamp', 'timeStamp', {unique: false})

      // })
      // .catch((error) => {
      //   if (error.name === 'ConstraintError') console.log('objectStore already created')
      //   if (error.name !== 'ConstraintError') throw new Error(error)
      // })

      const timeNow = () => {
        let datetime = new Date()
        let options = {
          year: 'numeric',
          month: 'numeric',
          day: 'numeric',
          hour: 'numeric',
          minute: 'numeric',
          weekday: 'long',
          hour12: false,
          timeZone: 'Asia/Shanghai'
        }
        return {
          'string': new Intl.DateTimeFormat('zh-Hans-CN', options).format(datetime),
          'value': datetime.valueOf()
        }
      }

      const SubmitButton = () => {
        let submitButton = document.createElement('div')
        submitButton.classList.add('submitButton')
        submitButton.hidden = true
        submitButton.textContent = 'Submit'
        submitButton.addEventListener('click', (event) => {
          let signedData
          database.matchOnly('food', 'status', 'SIGNED')
          .then((data) => {
            signedData = data
            let transactions = data.map(v => v.transaction)
            return sawtooth.buildBatch(transactions)
          })
          .then((batch) => {
            return sawtooth.send([batch], `${serverAddress}/batches`)
          })
          .then((response) => {
            let params = (new URL(response.link)).searchParams
            let batchID = params.get('id')

            let submittedData = signedData.map((v) => {
              v.batchID = batchID
              v.status = 'SUBMITTED'
              return v
            })
            return database.updateAll('food', submittedData)
          })
          .then((updated) => {
            let foodItems = document.querySelectorAll('food-item')
            foodItems.forEach((v) => {
              v.setAttribute('data-status', 'SUBMITTED')
              document.body.appendChild(v)
            })
            submitButton.hidden = true
          })
          .catch((error) => {
            console.log(error)
          })
        })

        return submitButton
      }

      const SignButton = () => {
        let signButton = document.createElement('div')
        signButton.classList.add('signButton')
        signButton.hidden = true
        signButton.textContent = 'Sign'
        signButton.addEventListener('click', (event) => {
          if (signButton.classList.contains('active')) {
            let data = foodEditor.compileData()

            let foodItem = document.createElement('food-item')
            foodItem.update(data)
            foodItem.build()
            .then((transaction) => {
              data.timeStamp = Date.now()
              data.status = 'SIGNED'
              data.transaction = transaction
              return database.insertAll('food', [data])
            })
            .then(() => {
              foodEditor.nutrientTable.shadow.querySelectorAll('li:not(.constituentSelector)').forEach((n) => {
                n.remove()
              })
              foodEditor.nameInput.value = ''
              foodEditor.addressNameState
              foodEditor.nutrientTable.selector.hidden = true
              signButton.hidden = true
              document.body.insertBefore(foodItem, submitButton)
              submitButton.hidden = false
            })
          }
        })

        return signButton
      }

      window.foodEditor = document.createElement('food-editor')
      foodEditor.NameAddressStateChange = (state) => {
        if (state === 'NON-EXISTS') signButton.classList.add('active')
      }
      foodEditor.inputStateChange = (state) => {
        if (state === 'NON-EMPTY') signButton.hidden = false
        if (state === 'EMPTY') signButton.hidden = true
        signButton.classList.remove('active')
      }

      document.body.appendChild(foodEditor)

      let signButton = SignButton()
      document.body.appendChild(signButton)

      let submitButton = SubmitButton()
      document.body.appendChild(submitButton)
      

      database.matchOnly('food', 'status', 'SIGNED')
      .then((data) => {
        data.forEach((v) => {
          let foodItem = document.createElement('food-item')
          let data = Object.assign({}, v)
          delete data.status
          delete data.transaction
          delete data.timeStamp

          foodItem.update(data)
          document.body.insertBefore(foodItem, submitButton)
        })

        if (data.length > 0) submitButton.hidden = false
      })

    </script>
  </body>
</html>

