<html>
  <head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
    <script src="../../dist/external/cbor.js" type="text/javascript"></script>
    <script src="../../dist/external/elliptic.min.js" type="text/javascript"></script>
    <script src="../../dist/external/protobuf.min.js" type="text/javascript"></script>
    <script src="../../dist/external/jss.min.js"></script>
    <script src="../../dist/external/jss-nested.min.js"></script>
    <style>
      body {
        background-color: whitesmoke;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import nutrientTable from '../../src/nutrientTable.js'
      customElements.define('nutrient-table', nutrientTable)

      import foodEditor from '../../src/foodEditor.js'
      customElements.define('food-editor', foodEditor)

      import foodItem from '../../src/foodItem.js'
      customElements.define('food-item', foodItem)
    </script>

    <script type='module'>
      import { IndexedDB } from '../../src/indexedDB.js'
      window.database = new IndexedDB('foodChain')

      database.update()
      .then((db) => {
        let foodStore = db.createObjectStore('food', {keyPath: 'name'})
        foodStore.createIndex('name', 'name', {unique: true})
        foodStore.createIndex('status', 'status', {unique: false})
        foodStore.createIndex('timeStamp', 'timeStamp', {unique: false})

        let consumptionStore = db.createObjectStore('consumption', {keyPath: 'datetime'})
        consumptionStore.createIndex('datetime', 'datetime', {unique: true})
        consumptionStore.createIndex('status', 'status', {unique: false})
        consumptionStore.createIndex('timeStamp', 'timeStamp', {unique: false})

      })
      .catch((error) => {
        if (error.name === 'ConstraintError') console.log('objectStore already created')
        if (error.name !== 'ConstraintError') throw new Error(error)
      })

      window.serverAddress = ''

      const timeNow = () => {
        let datetime = new Date()
        let options = {
          year: 'numeric',
          month: 'numeric',
          day: 'numeric',
          hour: 'numeric',
          minute: 'numeric',
          weekday: 'long',
          hour12: false,
          timeZone: 'Asia/Shanghai'
        }
        return {
          'string': new Intl.DateTimeFormat('zh-Hans-CN', options).format(datetime),
          'value': datetime.valueOf()
        }
      }

      window.foodEditor = document.createElement('food-editor')
      foodEditor.sign = () => {
        let data = foodEditor.compileData()

        let foodItem = document.createElement('food-item')
        foodItem.update(data)

        let now = new Date()
        data.timeStamp = now.valueOf()
        data.status = 'SIGNED'
        database.insertAll('food', [data])

        document.body.appendChild(foodItem)
      }
      document.body.appendChild(foodEditor)

    </script>
  </body>
</html>

