<html>
  <head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
    <script src="../../dist/external/cbor.js" type="text/javascript"></script>
    <script src="../../dist/external/elliptic.min.js" type="text/javascript"></script>
    <script src="../../dist/external/protobuf.min.js" type="text/javascript"></script>
    <script src="../../dist/external/jss.min.js"></script>
    <script src="../../dist/external/jss-nested.min.js"></script>
    <style>
      body {
        background-color: whitesmoke;
      }

      div.submitButton {
        height: 30px;
        width: 60px;
        line-height:30px;
        text-align: center;
        background-color: white;
        margin-top: 10px;
        margin-bottom: 20px;
        float: right;
        font-family: sans-serif;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import nutrientTable from '../../src/nutrientTable.js'
      customElements.define('nutrient-table', nutrientTable)

      import foodEditor from '../../src/foodEditor.js'
      customElements.define('food-editor', foodEditor)

      import foodItem from '../../src/foodItem.js'
      customElements.define('food-item', foodItem)

      import { generateNewKey, importKey, Sawtooth } from '../../src/sawtooth.js'

      let key
      try {
        key = importKey()
      } catch (error) {
        if (error.message === 'there is no key') generateNewKey()
      }

      window.sawtooth = new Sawtooth(key)
      // sawtooth.init(['../../dist/external/proto/batch.proto', '../../dist/external/proto/transaction.proto'])

    </script>

    <script type='module'>
      import { IndexedDB } from '../../src/indexedDB.js'
      window.database = new IndexedDB('foodChain')

      // database.update()
      // .then((db) => {
      //   let foodStore = db.createObjectStore('food', {keyPath: 'name'})
      //   foodStore.createIndex('name', 'name', {unique: true})
      //   foodStore.createIndex('status', 'status', {unique: false})
      //   foodStore.createIndex('timeStamp', 'timeStamp', {unique: false})

      //   let consumptionStore = db.createObjectStore('consumption', {keyPath: 'datetime'})
      //   consumptionStore.createIndex('datetime', 'datetime', {unique: true})
      //   consumptionStore.createIndex('status', 'status', {unique: false})
      //   consumptionStore.createIndex('timeStamp', 'timeStamp', {unique: false})

      // })
      // .catch((error) => {
      //   if (error.name === 'ConstraintError') console.log('objectStore already created')
      //   if (error.name !== 'ConstraintError') throw new Error(error)
      // })

      window.serverAddress = ''

      const timeNow = () => {
        let datetime = new Date()
        let options = {
          year: 'numeric',
          month: 'numeric',
          day: 'numeric',
          hour: 'numeric',
          minute: 'numeric',
          weekday: 'long',
          hour12: false,
          timeZone: 'Asia/Shanghai'
        }
        return {
          'string': new Intl.DateTimeFormat('zh-Hans-CN', options).format(datetime),
          'value': datetime.valueOf()
        }
      }

      window.foodEditor = document.createElement('food-editor')
      foodEditor.sign = () => {
        let data = foodEditor.compileData()

        let foodItem = document.createElement('food-item')
        foodItem.update(data)

        let now = new Date()
        data.timeStamp = now.valueOf()
        data.status = 'SIGNED'

        database.insertAll('food', [data])

        document.body.appendChild(foodItem)
        foodEditor.nameInput.value = ''
      }
      document.body.appendChild(foodEditor)

      
    </script>

    <script type='module'>
      let data = {
        name: 'signedapple',
        status: 'SIGNED',
        timeStamp: Date.now()
      }
      database.insertAll('food', [data])
      .catch((event) => {
        if (event.target.error.messsage = 'Key already exists in the object store.') {
          console.log('ignore this for now')
        }
      })
    </script>

    <script type='module'>
      function SubmitButton () {
        let submitButton = document.createElement('div')
        submitButton.classList.add('submitButton')
        submitButton.textContent = 'Submit'

        submitButton.addEventListener('click', (event) => {
          
        })

        return submitButton
      }

      database.matchOnly('food', 'status', 'SIGNED')
      .then((data) => {
        data.forEach((v) => {
          let foodItem = document.createElement('food-item')
          foodItem.update(v)

          document.body.appendChild(foodItem)
        })

        if (data.length > 0) {
          let submitButton = SubmitButton()
          document.body.appendChild(submitButton)
        }
      })
    </script>
  </body>
</html>

